<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager - Full Stack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        #rainCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        .glass-card {
            background-color: rgba(31, 41, 55, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(75, 85, 99, 0.5);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <canvas id="rainCanvas"></canvas>

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl relative z-10">

        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-100">My Tasks</h1>
            <div id="userInfo" class="hidden">
                <span id="usernameDisplay" class="mr-4 font-medium"></span>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Logout</button>
            </div>
        </header>

        <!-- Login/Register View -->
        <div id="authView">
            <div class="glass-card p-8 rounded-xl shadow-lg max-w-md mx-auto">
                <h2 id="authTitle" class="text-2xl font-bold text-center mb-6 text-white">Login</h2>
                <div id="authError" class="text-red-400 text-center mb-4 hidden"></div>
                <form id="authForm" onsubmit="handleAuth(event)">
                    <div class="mb-4">
                        <label for="username" class="block text-gray-300 text-sm font-bold mb-2">Username</label>
                        <input type="text" id="username" class="bg-gray-700 border border-gray-600 text-white shadow appearance-none rounded-lg w-full py-3 px-4 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-300 text-sm font-bold mb-2">Password</label>
                        <input type="password" id="password" class="bg-gray-700 border border-gray-600 text-white shadow appearance-none rounded-lg w-full py-3 px-4 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button id="authButton" type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-300">
                        Sign In
                    </button>
                </form>
                <p class="text-center text-gray-400 text-sm mt-6">
                    <a href="#" id="toggleAuth" onclick="toggleAuthMode(event)" class="font-bold text-blue-400 hover:text-blue-300">
                        Don't have an account? Register
                    </a>
                </p>
            </div>
        </div>

        <!-- Main Content View (Tasks) -->
        <main id="mainView" class="hidden">
            <div class="glass-card p-6 rounded-xl shadow-lg mb-8">
                 <h2 class="text-xl font-semibold mb-4 text-white">Add New Task</h2>
                 <form id="taskForm" onsubmit="createTask(event)" class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                    <div class="md:col-span-2">
                        <label for="taskTitle" class="block text-sm font-medium text-gray-300">Title</label>
                        <input type="text" id="taskTitle" class="mt-1 block w-full bg-gray-700 border border-gray-600 text-white rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="taskDescription" class="block text-sm font-medium text-gray-300">Description</label>
                        <input type="text" id="taskDescription" class="mt-1 block w-full bg-gray-700 border border-gray-600 text-white rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-1">
                         <label for="taskDueDate" class="block text-sm font-medium text-gray-300">Due Date</label>
                         <input type="date" id="taskDueDate" class="mt-1 block w-full bg-gray-700 border border-gray-600 text-white rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-1">
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Add Task</button>
                    </div>
                </form>
            </div>
            <div id="taskList" class="space-y-4"></div>
        </main>
    </div>

    <!-- Script for Task Manager Logic -->
    <script>
        // --- CONFIGURATION ---
        // IMPORTANT: Replace this with the URL of your running API
        const API_BASE_URL = 'https://taskmanager-api-v0ie.onrender.com';

        // --- STATE MANAGEMENT ---
        let isLoginMode = true;
        
        // --- DOM ELEMENTS ---
        const authView = document.getElementById('authView');
        const mainView = document.getElementById('mainView');
        const userInfo = document.getElementById('userInfo');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const authTitle = document.getElementById('authTitle');
        const authButton = document.getElementById('authButton');
        const toggleAuth = document.getElementById('toggleAuth');
        const authError = document.getElementById('authError');
        const taskList = document.getElementById('taskList');

        // --- API HELPER FUNCTIONS ---
        function getToken() {
            return localStorage.getItem('jwt_token');
        }

        function setToken(token) {
            localStorage.setItem('jwt_token', token);
        }

        function removeToken() {
            localStorage.removeItem('jwt_token');
        }

        // --- UI FUNCTIONS ---
        function showView(view) {
            authView.classList.add('hidden');
            mainView.classList.add('hidden');
            userInfo.classList.add('hidden');
            document.getElementById(view).classList.remove('hidden');
            if (view === 'mainView') {
                userInfo.classList.remove('hidden');
            }
        }

        function toggleAuthMode(event) {
            event.preventDefault();
            isLoginMode = !isLoginMode;
            authError.classList.add('hidden');
            document.getElementById('authForm').reset();

            if (isLoginMode) {
                authTitle.innerText = 'Login';
                authButton.innerText = 'Sign In';
                toggleAuth.innerHTML = 'Don\'t have an account? <strong>Register</strong>';
            } else {
                authTitle.innerText = 'Register';
                authButton.innerText = 'Create Account';
                toggleAuth.innerHTML = 'Already have an account? <strong>Login</strong>';
            }
        }

        function showError(message) {
            authError.innerText = message;
            authError.classList.remove('hidden');
        }

        // --- CORE LOGIC (API CALLS) ---
        async function handleAuth(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const endpoint = isLoginMode ? 'login' : 'register';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Authentication failed.');
                }

                if (isLoginMode) {
                    const result = await response.json();
                    setToken(result.token);
                    usernameDisplay.innerText = `Welcome, ${username}!`;
                    showView('mainView');
                    await fetchTasks();
                } else {
                    alert('Registration successful! Please log in.');
                    toggleAuthMode(event);
                }
            } catch (error) {
                showError(error.message);
            }
        }
        
        function logout() {
            removeToken();
            showView('authView');
            taskList.innerHTML = '';
        }

        async function fetchTasks() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/tasks`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (!response.ok) throw new Error('Could not fetch tasks.');
                
                const tasks = await response.json();
                taskList.innerHTML = ''; // Clear list
                if (tasks.length === 0) {
                     taskList.innerHTML = `<div class="text-center p-8 glass-card rounded-xl shadow-lg"><p class="text-gray-400">No tasks found. Add one!</p></div>`;
                } else {
                    tasks.forEach(renderTask);
                }
            } catch (error) {
                console.error(error);
                alert(error.message);
            }
        }

        async function createTask(event) {
            event.preventDefault();
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const dueDate = document.getElementById('taskDueDate').value;

            try {
                 const response = await fetch(`${API_BASE_URL}/api/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({ title, description, dueDate, status: 'To Do' })
                });
                if (!response.ok) throw new Error('Failed to create task.');
                
                document.getElementById('taskForm').reset();
                await fetchTasks(); // Refresh the list
            } catch (error) {
                 console.error(error);
                 alert(error.message);
            }
        }

        async function updateTaskStatus(taskId, newStatus, currentTask) {
             try {
                const response = await fetch(`${API_BASE_URL}/api/tasks/${taskId}`, {
                    method: 'PUT',
                     headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({ ...currentTask, status: newStatus })
                });
                if (!response.ok) throw new Error('Failed to update task.');
                await fetchTasks(); // Refresh the list
            } catch (error) {
                 console.error(error);
                 alert(error.message);
            }
        }
        
        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;
            try {
                const response = await fetch(`${API_BASE_URL}/api/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                if (!response.ok) throw new Error('Failed to delete task.');
                await fetchTasks(); // Refresh the list
            } catch (error) {
                console.error(error);
                alert(error.message);
            }
        }
        
        function renderTask(task) {
            const taskElement = document.createElement('div');
            taskElement.className = 'glass-card p-5 rounded-xl shadow-lg flex items-start justify-between space-x-4';
            taskElement.id = `task-${task.id}`;

            const statusColors = {
                'To Do': 'bg-blue-900 text-blue-200',
                'In Progress': 'bg-yellow-900 text-yellow-200',
                'Done': 'bg-green-900 text-green-200'
            };
            const statusColor = statusColors[task.status] || 'bg-gray-700 text-gray-200';
            const formattedDate = new Date(task.dueDate).toLocaleDateString();

            taskElement.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-center mb-2">
                        <p class="font-bold text-lg ${task.status === 'Done' ? 'line-through text-gray-500' : 'text-gray-100'}">${task.title}</p>
                        <span class="ml-3 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full ${statusColor}">${task.status}</span>
                    </div>
                    <p class="text-gray-300 ${task.status === 'Done' ? 'line-through' : ''}">${task.description}</p>
                    <p class="text-sm text-gray-400 mt-2">Due: ${formattedDate}</p>
                </div>
                <div class="flex flex-col space-y-2">
                    <select onchange='updateTaskStatus(${task.id}, this.value, ${JSON.stringify(task)})' class="bg-gray-700 border border-gray-600 text-white rounded-md text-sm p-1 focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="To Do" ${task.status === 'To Do' ? 'selected' : ''}>To Do</option>
                        <option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                        <option value="Done" ${task.status === 'Done' ? 'selected' : ''}>Done</option>
                    </select>
                    <button onclick="deleteTask(${task.id})" class="text-red-400 hover:text-red-300 font-semibold text-sm">Delete</button>
                </div>
            `;
            taskList.appendChild(taskElement);
        }

        // --- INITIALIZATION ---
        function initialize() {
            const token = getToken();
            if (token) {
                // You could add token validation here if needed
                showView('mainView');
                fetchTasks();
            } else {
                showView('authView');
            }
        }
        
        initialize();
    </script>

    <!-- Script for Rain Effect -->
    <script>
        const canvas = document.getElementById('rainCanvas');
        const ctx = canvas.getContext('2d');
        let drops = [];
        function setup() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            for (let i = 0; i < 500; i++) {
                drops.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    length: Math.random() * 20 + 10,
                    speed: Math.random() * 5 + 2
                });
            }
        }
        function draw() {
            ctx.fillStyle = 'rgba(17, 24, 39, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'rgba(175, 200, 255, 0.5)';
            ctx.lineWidth = 1;
            ctx.lineCap = 'round';
            for (let i = 0; i < drops.length; i++) {
                const drop = drops[i];
                ctx.beginPath();
                ctx.moveTo(drop.x, drop.y);
                ctx.lineTo(drop.x, drop.y + drop.length);
                ctx.stroke();
                drop.y += drop.speed;
                if (drop.y > canvas.height) {
                    drop.y = -drop.length;
                    drop.x = Math.random() * canvas.width;
                }
            }
            requestAnimationFrame(draw);
        }
        window.addEventListener('resize', setup);
        setup();
        draw();
    </script>
</body>
</html>
